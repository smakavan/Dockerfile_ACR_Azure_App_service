trigger: none

pool:
  name: 'Local-Linux'

variables:
  imageName: amazon-app
  registry: sacdockerzure.azurecr.io
  tag: $(Build.BuildId)

steps:
# Step 1: Checkout GitHub repo
- checkout: self

# Step 2: Login to ACR
- task: Docker@2
  displayName: "Login to ACR"
  inputs:
    command: login
    containerRegistry: ACR-Connection

# Step 3: Build Docker image
- task: Docker@2
  displayName: "Build Docker Image"
  inputs:
    command: build
    containerRegistry: 'ACR-Connection'   # must match your service connection name
    repository: $(imageName)              # gives image a repo name
    dockerfile: '**/Dockerfile'       # Dockerfile path
    buildContext: '.'
    tags: |
      $(tag)

# Step 4: Push Docker image to ACR
- task: Docker@2
  displayName: "Push Docker Image"
  inputs:
    command: push
    containerRegistry: 'ACR-Connection'
    repository: $(imageName)              # same repo name as above
    tags: |
      $(tag)

# Step 5: Deploy to Azure App Service (Linux Container)
- task: AzureWebAppContainer@1
  displayName: "Deploy to Azure App Service"
  inputs:
    azureSubscription: 'KeyVault-Sac'  # Service connection to Azure
    appName: 'myapp-service'           # Your App Service name
    containers: |
      $(registry)/$(imageName):$(tag)
